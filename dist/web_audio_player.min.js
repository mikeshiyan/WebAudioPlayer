!function(){"use strict";function e(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=void 0,o=void 0,u={},s=function(){function e(){n(this,e)}return r(e,null,[{key:"getArrayBuffer",value:function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.onload=function(){200===r.status||206===r.status?t(r.response):n(new Error(r.statusText))},r.onerror=function(){n(new Error("Unknown error."))},r.send()})}},{key:"loadUrl",value:function(t){var n=e.getUrlPromise(t);if(!n){var r=function(t,n){return t.catch(function(){return e.getArrayBuffer(n).then(function(t){return e.audio.OfflineContext.decodeAudioData(t)})})};n=t.reduce(r,Promise.reject()).then(function(n){return e.removeUrlPromise(t),n}).catch(function(){throw new Error("No valid audio URLs provided.")}),e.setUrlPromise(t,n)}return n}},{key:"getUrlPromise",value:function(e){for(var t in e)if(e.hasOwnProperty(t)&&u[e[t]])return u[e[t]]}},{key:"removeUrlPromise",value:function(e){e.forEach(function(e){delete u[e]})}},{key:"setUrlPromise",value:function(e,t){e.forEach(function(e){u[e]=t})}},{key:"readStorage",value:function(e){if("undefined"!=typeof localStorage)return JSON.parse(localStorage.getItem("WebAudioPlayer."+e))}},{key:"updateStorage",value:function(e,t){"undefined"!=typeof localStorage&&localStorage.setItem("WebAudioPlayer."+e,JSON.stringify(t))}},{key:"audio",get:function(){return i||(i=new c),i}},{key:"player",set:function(e){if(!(e instanceof l))throw new TypeError("Player parameter accepts the WebAudioPlayer instance only.");o=e},get:function(){return o}}]),e}(),a=function(){function e(){n(this,e),this.eventListeners={}}return r(e,[{key:"addEventListener",value:function(e,t){e in this.eventListeners||(this.eventListeners[e]=[]);for(var n=this.eventListeners[e],r=!1,i=0,o=n.length;i<o;i++)if(n[i]===t){r=!0;break}r||this.eventListeners[e].push(t)}},{key:"removeEventListener",value:function(e,t){if(e in this.eventListeners)for(var n=this.eventListeners[e],r=0,i=n.length;r<i;r++)if(n[r]===t){n.splice(r,1);break}}},{key:"dispatchEvent",value:function(e){if(e in this.eventListeners)for(var t=this.eventListeners[e],n=Array.prototype.slice.call(arguments,1),r=0,i=t.length;r<i;r++)t[r].apply(this,n)}}]),e}(),c=function e(){n(this,e),this.Context=new(window.AudioContext||window.webkitAudioContext),this.OfflineContext=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,2,this.Context.sampleRate),this.Analyser=this.Context.createAnalyser(),this.Gain=this.Context.createGain(),this.ScriptProcessor=this.Context.createScriptProcessor(),this.filters=[];for(var t=[60,170,310,600,1e3,3e3,6e3,12e3,14e3,16e3],r=0;r<10;r++)this.filters[r]=this.Context.createBiquadFilter(),this.filters[r].frequency.value=t[r],0===r?this.filters[0].type="lowshelf":9===r?this.filters[9].type="highshelf":this.filters[r].type="peaking",r>0&&this.filters[r-1].connect(this.filters[r]);this.Analyser.connect(this.filters[0]),this.filters[9].connect(this.Gain).connect(this.Context.destination),this.ScriptProcessor.connect(this.Context.destination)},f=function(r){function i(t){n(this,i);var r=e(this,(i.__proto__||Object.getPrototypeOf(i)).call(this)),o=!1,u=[],a=[],c=0,f=0,l=0,h=0,p=null,d=r,v=function(){for(var e in a)if(a[e].m<=f){setTimeout(a[e].fn.bind(r),0),a.splice(e,1);break}},y=function(){o&&(f=r.getCurrentTime()-h,v(),r.dispatchEvent("playing"))};return r.play=function(){if(!o&&c<t.duration){var e=s.audio,n=s.player;o=!0,c=Math.max(c,0);var r=Math.max(t.duration-c,0);n.addEventListener("audioprocess",y),p=e.Context.createBufferSource(),p.connect(e.Analyser),p.buffer=t,p.onended=function(){this.finished=!0,p.finished&&o&&(o=!1,h=c=t.duration,d.dispatchEvent("finished"),n.removeEventListener("audioprocess",y),a=u.slice(0))},l=e.Context.currentTime,p.start(0,c,r)}return this},r.stop=function(){return o=!1,p&&p.stop(),h=c=0,s.player.removeEventListener("audioprocess",y),a=u.slice(0),this},r.pause=function(){var e=o;return o=!1,p&&p.stop(),e&&(c+=s.audio.Context.currentTime-l),s.player.removeEventListener("audioprocess",y),this},r.seek=function(e){if(e<0)throw new TypeError("Offset parameter accepts non-negative numbers only.");return h+=e-this.getCurrentTime(),o?(o=!1,p&&p.stop(),c=e,this.play()):c=e,this},r.when=function(e,t){if(e<0)throw new TypeError("Marker parameter accepts non-negative numbers only.");var n={m:e,fn:t};return a.push(n),u.push(n),this},r.getCurrentTime=function(){return o?s.audio.Context.currentTime-l+c:c},r.getPlayedTime=function(){return f},r.getDuration=function(){return t.duration},r.isPlaying=function(){return o},r}return t(i,r),i}(a),l=function(i){function o(){n(this,o);var t=e(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));s.player=t,s.audio.ScriptProcessor.onaudioprocess=function(){t.dispatchEvent("audioprocess")};var r=s.readStorage("eq"),i=s.readStorage("vol");return r&&t.setEq(r),i&&t.setVolume(i),t}return t(o,i),r(o,[{key:"getAudio",value:function(){return s.audio}},{key:"loadUrl",value:function(e){return s.loadUrl(e).then(function(e){return new f(e)})}},{key:"setVolume",value:function(e){return s.audio.Gain.gain.value=e,s.updateStorage("vol",e),this}},{key:"getVolume",value:function(){return s.audio.Gain.gain.value}},{key:"setEq",value:function(e){var t=s.audio;for(var n in e)e.hasOwnProperty(n)&&t.filters[n]&&(t.filters[n].gain.value=e[n]);return s.updateStorage("eq",this.getEq()),this}},{key:"getEq",value:function(){return s.audio.filters.map(function(e){return e.gain.value})}}]),o}(a);window.WebAudioPlayer=l}();