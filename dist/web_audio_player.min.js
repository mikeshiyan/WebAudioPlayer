!function(){"use strict";function e(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=void 0,o=function(){function e(){n(this,e)}return r(e,null,[{key:"getArrayBuffer",value:function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.onload=function(){200===r.status||206===r.status?t(r.response):n(new Error(r.statusText))},r.onerror=function(){n(new Error("Unknown error."))},r.send()})}},{key:"getUrlPromise",value:function(t){for(var n in t)if(t.hasOwnProperty(n)&&e.urlPromises[t[n]])return e.urlPromises[t[n]]}},{key:"removeUrlPromise",value:function(t){t.forEach(function(t){delete e.urlPromises[t]})}},{key:"setUrlPromise",value:function(t,n){t.forEach(function(t){e.urlPromises[t]=n})}},{key:"readStorage",value:function(e){if("undefined"!=typeof localStorage)return JSON.parse(localStorage.getItem("WebAudioPlayer."+e))}},{key:"updateStorage",value:function(e,t){"undefined"!=typeof localStorage&&localStorage.setItem("WebAudioPlayer."+e,JSON.stringify(t))}},{key:"audio",get:function(){return i||(i=new u),i}}]),e}();o.urlPromises={};var s=function(){function e(){n(this,e),this.eventListeners={}}return r(e,[{key:"addEventListener",value:function(e,t){e in this.eventListeners||(this.eventListeners[e]=[]);for(var n=this.eventListeners[e],r=!1,i=0,o=n.length;i<o;i++)if(n[i]===t){r=!0;break}r||this.eventListeners[e].push(t)}},{key:"removeEventListener",value:function(e,t){if(e in this.eventListeners)for(var n=this.eventListeners[e],r=0,i=n.length;r<i;r++)if(n[r]===t){n.splice(r,1);break}}},{key:"dispatchEvent",value:function(e){if(e in this.eventListeners)for(var t=this.eventListeners[e],n=Array.prototype.slice.call(arguments,1),r=0,i=t.length;r<i;r++)t[r].apply(this,n)}}]),e}(),u=function e(){n(this,e),this.Context=new(window.AudioContext||window.webkitAudioContext),this.OfflineContext=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,2,this.Context.sampleRate),this.Analyser=this.Context.createAnalyser(),this.Gain=this.Context.createGain(),this.ScriptProcessor=this.Context.createScriptProcessor(),this.filters=[];for(var t=[60,170,310,600,1e3,3e3,6e3,12e3,14e3,16e3],r=0;r<10;r++)this.filters[r]=this.Context.createBiquadFilter(),this.filters[r].frequency.value=t[r],0===r?this.filters[0].type="lowshelf":9===r?this.filters[9].type="highshelf":this.filters[r].type="peaking",r>0&&this.filters[r-1].connect(this.filters[r]);this.Analyser.connect(this.filters[0]),this.filters[9].connect(this.Gain).connect(this.Context.destination),this.ScriptProcessor.connect(this.Context.destination)},a=function(r){function i(t,r){n(this,i);var s=e(this,(i.__proto__||Object.getPrototypeOf(i)).call(this)),u=!1,a=[],c=[],f=0,l=0,h=0,p=0,d=null,v=s,y=function(){for(var e in c)if(c[e].m<=l){setTimeout(c[e].fn.bind(v),0),c.splice(e,1);break}},m=function(){u&&(l=v.getCurrentTime()-p,y(),v.dispatchEvent("playing"))};return s.play=function(){if(!u&&f<t.duration){var e=o.audio;u=!0,f=Math.max(f,0);var n=Math.max(t.duration-f,0);r.addEventListener("audioprocess",m),d=e.Context.createBufferSource(),d.connect(e.Analyser),d.buffer=t,d.onended=function(){this.finished=!0,d.finished&&u&&(u=!1,p=f=t.duration,v.dispatchEvent("finished"),r.removeEventListener("audioprocess",m),c=a.slice(0))},h=e.Context.currentTime,d.start(0,f,n)}return this},s.stop=function(){return u=!1,d&&d.stop(),p=f=0,r.removeEventListener("audioprocess",m),c=a.slice(0),this},s.pause=function(){var e=u;return u=!1,d&&d.stop(),e&&(f+=o.audio.Context.currentTime-h),r.removeEventListener("audioprocess",m),this},s.seek=function(e){if(e<0)throw new TypeError("Offset parameter accepts non-negative numbers only.");return p+=e-this.getCurrentTime(),u?(u=!1,d&&d.stop(),f=e,this.play()):f=e,this},s.when=function(e,t){if(e<0)throw new TypeError("Marker parameter accepts non-negative numbers only.");var n={m:e,fn:t};return c.push(n),a.push(n),this},s.getCurrentTime=function(){return u?o.audio.Context.currentTime-h+f:f},s.getPlayedTime=function(){return l},s.getDuration=function(){return t.duration},s.isPlaying=function(){return u},s}return t(i,r),i}(s),c=function(i){function s(){n(this,s);var t=e(this,(s.__proto__||Object.getPrototypeOf(s)).call(this)),r=t;o.audio.ScriptProcessor.onaudioprocess=function(){r.dispatchEvent("audioprocess")};var i=o.readStorage("eq"),u=o.readStorage("vol");return i&&t.setEq(i),u&&t.setVolume(u),t}return t(s,i),r(s,[{key:"getAudio",value:function(){return o.audio}},{key:"loadUrl",value:function(e){var t=this,n=o.getUrlPromise(e);return n||(n=e.reduce(function(e,t){return e.catch(function(){return o.getArrayBuffer(t).then(function(e){return o.audio.OfflineContext.decodeAudioData(e)})})},Promise.reject()).then(function(n){return o.removeUrlPromise(e),new a(n,t)}).catch(function(){throw new Error("No valid audio URLs provided.")}),o.setUrlPromise(e,n)),n}},{key:"setVolume",value:function(e){return o.audio.Gain.gain.value=e,o.updateStorage("vol",e),this}},{key:"getVolume",value:function(){return o.audio.Gain.gain.value}},{key:"setEq",value:function(e){var t=o.audio;for(var n in e)e.hasOwnProperty(n)&&t.filters[n]&&(t.filters[n].gain.value=e[n]);return o.updateStorage("eq",this.getEq()),this}},{key:"getEq",value:function(){var e=[];return o.audio.filters.forEach(function(t){e.push(t.gain.value)}),e}}]),s}(s);window.WebAudioPlayer=c}();