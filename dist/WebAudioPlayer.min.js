!function(){"use strict";function e(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(){n(this,e)}return r(e,null,[{key:"getArrayBuffer",value:function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.onload=function(){200===r.status||206===r.status?t(r.response):n(new Error(r.statusText))},r.onerror=function(){n(new Error("Unknown error."))},r.send()})}},{key:"getUrlPromise",value:function(t){for(var n in t)if(t.hasOwnProperty(n)&&e.urlPromises[t[n]])return e.urlPromises[t[n]]}},{key:"removeUrlPromise",value:function(t){t.forEach(function(t){delete e.urlPromises[t]})}},{key:"setUrlPromise",value:function(t,n){t.forEach(function(t){e.urlPromises[t]=n})}},{key:"readStorage",value:function(e){if("undefined"!=typeof localStorage)return JSON.parse(localStorage.getItem("WebAudioPlayer."+e))}},{key:"updateStorage",value:function(e,t){"undefined"!=typeof localStorage&&localStorage.setItem("WebAudioPlayer."+e,JSON.stringify(t))}}]),e}();i.urlPromises={};var o=function(){function e(){n(this,e),this.eventListeners={}}return r(e,[{key:"addEventListener",value:function(e,t){e in this.eventListeners||(this.eventListeners[e]=[]);for(var n=this.eventListeners[e],r=!1,i=0,o=n.length;i<o;i++)if(n[i]===t){r=!0;break}r||this.eventListeners[e].push(t)}},{key:"removeEventListener",value:function(e,t){if(e in this.eventListeners)for(var n=this.eventListeners[e],r=0,i=n.length;r<i;r++)if(n[r]===t){n.splice(r,1);break}}},{key:"dispatchEvent",value:function(e){if(e in this.eventListeners)for(var t=this.eventListeners[e],n=Array.prototype.slice.call(arguments,1),r=0,i=t.length;r<i;r++)t[r].apply(this,n)}}]),e}(),s=function e(){n(this,e),this.Context=new(window.AudioContext||window.webkitAudioContext),this.OfflineContext=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,2,this.Context.sampleRate),this.Analyser=this.Context.createAnalyser(),this.Gain=this.Context.createGain(),this.ScriptProcessor=this.Context.createScriptProcessor(),this.filters=[];for(var t=[60,170,310,600,1e3,3e3,6e3,12e3,14e3,16e3],r=0;r<10;r++)this.filters[r]=this.Context.createBiquadFilter(),this.filters[r].frequency.value=t[r],0===r?this.filters[0].type="lowshelf":9===r?this.filters[9].type="highshelf":this.filters[r].type="peaking",r>0&&this.filters[r-1].connect(this.filters[r]);this.Analyser.connect(this.filters[0]),this.filters[9].connect(this.Gain).connect(this.Context.destination),this.ScriptProcessor.connect(this.Context.destination)},u=function(r){function i(t,r){n(this,i);var o=e(this,(i.__proto__||Object.getPrototypeOf(i)).call(this)),s=!1,u=[],a=[],c=0,f=0,l=0,h=0,p=null,d=o,v=function(){for(var e in a)if(a[e].m<=f){setTimeout(a[e].fn.bind(d),0),a.splice(e,1);break}},y=function(){s&&(f=d.getCurrentTime()-h,v(),d.dispatchEvent("playing"))};return o.play=function(){if(!s&&c<t.duration){s=!0,c=Math.max(c,0);var e=Math.max(t.duration-c,0);r.addEventListener("audioprocess",y),p=r.getAudio().Context.createBufferSource(),p.connect(r.getAudio().Analyser),p.buffer=t,p.onended=function(){this.finished=!0,p.finished&&s&&(s=!1,h=c=t.duration,d.dispatchEvent("finished"),r.removeEventListener("audioprocess",y),a=u.slice(0))},l=r.getAudio().Context.currentTime,p.start(0,c,e)}return this},o.stop=function(){return s=!1,p&&p.stop(),h=c=0,r.removeEventListener("audioprocess",y),a=u.slice(0),this},o.pause=function(){var e=s;return s=!1,p&&p.stop(),e&&(c+=r.getAudio().Context.currentTime-l),r.removeEventListener("audioprocess",y),this},o.seek=function(e){if(e<0)throw new TypeError("Offset parameter accepts non-negative numbers only.");return h+=e-this.getCurrentTime(),s?(s=!1,p&&p.stop(),c=e,this.play()):c=e,this},o.when=function(e,t){if(e<0)throw new TypeError("Marker parameter accepts non-negative numbers only.");var n={m:e,fn:t};return a.push(n),u.push(n),this},o.getCurrentTime=function(){return s?r.getAudio().Context.currentTime-l+c:c},o.getPlayedTime=function(){return f},o.getDuration=function(){return t.duration},o.isPlaying=function(){return s},o}return t(i,r),i}(o),a=function(o){function a(){n(this,a);var t=e(this,(a.__proto__||Object.getPrototypeOf(a)).call(this)),r=new s,o=t;t.getAudio=function(){return r},r.ScriptProcessor.onaudioprocess=function(){o.dispatchEvent("audioprocess")};var u=i.readStorage("eq"),c=i.readStorage("vol");return u&&t.setEq(u),c&&t.setVolume(c),t}return t(a,o),r(a,[{key:"loadUrl",value:function(e){var t=this,n=i.getUrlPromise(e);return n||(n=e.reduce(function(e,n){return e.catch(function(){return i.getArrayBuffer(n).then(function(e){return t.getAudio().OfflineContext.decodeAudioData(e)})})},Promise.reject()).then(function(n){return i.removeUrlPromise(e),new u(n,t)}).catch(function(){throw new Error("No valid audio URLs provided.")}),i.setUrlPromise(e,n)),n}},{key:"setVolume",value:function(e){return this.getAudio().Gain.gain.value=e,i.updateStorage("vol",e),this}},{key:"getVolume",value:function(){return this.getAudio().Gain.gain.value}},{key:"setEq",value:function(e){for(var t in e)e.hasOwnProperty(t)&&this.getAudio().filters[t]&&(this.getAudio().filters[t].gain.value=e[t]);return i.updateStorage("eq",this.getEq()),this}},{key:"getEq",value:function(){var e=[];return this.getAudio().filters.forEach(function(t){e.push(t.gain.value)}),e}}]),a}(o);window.WebAudioPlayer=a}();