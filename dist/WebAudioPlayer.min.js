!function(){"use strict";var t={};t.urlPromises={},t.getArrayBuffer=function(t){return new Promise(function(e,r){var n=new XMLHttpRequest;n.open("GET",t),n.responseType="arraybuffer",n.onload=function(){200===n.status||206===n.status?e(n.response):r(new Error(n.statusText))},n.onerror=function(){r(new Error("Unknown error."))},n.send()})},t.getUrlPromise=function(e){for(var r in e)if(e.hasOwnProperty(r)&&t.urlPromises[e[r]])return t.urlPromises[e[r]]},t.removeUrlPromise=function(e){e.forEach(function(e){delete t.urlPromises[e]})},t.setUrlPromise=function(e,r){e.forEach(function(e){t.urlPromises[e]=r})},t.readStorage=function(t){if("undefined"!=typeof localStorage)return JSON.parse(localStorage.getItem("WebAudioPlayer."+t))},t.updateStorage=function(t,e){"undefined"!=typeof localStorage&&localStorage.setItem("WebAudioPlayer."+t,JSON.stringify(e))};var e=function(){this.eventListeners={}};e.prototype.eventListeners=null,e.prototype.addEventListener=function(t,e){t in this.eventListeners||(this.eventListeners[t]=[]);for(var r=this.eventListeners[t],n=!1,i=0,o=r.length;i<o;i++)if(r[i]===e){n=!0;break}n||this.eventListeners[t].push(e)},e.prototype.removeEventListener=function(t,e){if(t in this.eventListeners)for(var r=this.eventListeners[t],n=0,i=r.length;n<i;n++)if(r[n]===e){r.splice(n,1);break}},e.prototype.dispatchEvent=function(t){if(t in this.eventListeners)for(var e=this.eventListeners[t],r=Array.prototype.slice.call(arguments,1),n=0,i=e.length;n<i;n++)e[n].apply(this,r)};var r=function(){this.Context=new(window.AudioContext||window.webkitAudioContext),this.OfflineContext=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,2,this.Context.sampleRate),this.Analyser=this.Context.createAnalyser(),this.Gain=this.Context.createGain(),this.ScriptProcessor=this.Context.createScriptProcessor(),this.filters=[];for(var t=[60,170,310,600,1e3,3e3,6e3,12e3,14e3,16e3],e=0;e<10;e++)this.filters[e]=this.Context.createBiquadFilter(),this.filters[e].frequency.value=t[e],0===e?this.filters[0].type="lowshelf":9===e?this.filters[9].type="highshelf":this.filters[e].type="peaking",e>0&&this.filters[e-1].connect(this.filters[e]);this.Analyser.connect(this.filters[0]),this.filters[9].connect(this.Gain).connect(this.Context.destination),this.ScriptProcessor.connect(this.Context.destination)};r.prototype.Analyser=null,r.prototype.Context=null,r.prototype.Gain=null,r.prototype.OfflineContext=null,r.prototype.ScriptProcessor=null,r.prototype.filters=[];var n=function(t,r){e.call(this);var n=!1,i=[],o=[],s=0,u=0,a=0,c=0,f=null,l=this,h=function(){for(var t in o)if(o[t].m<=u){setTimeout(o[t].fn.bind(l),0),o.splice(t,1);break}},p=function(){n&&(u=l.getCurrentTime()-c,h(),l.dispatchEvent("playing"))};this.play=function(){if(!n&&s<t.duration){n=!0,s=Math.max(s,0);var e=Math.max(t.duration-s,0);r.addEventListener("audioprocess",p),f=r.getAudio().Context.createBufferSource(),f.connect(r.getAudio().Analyser),f.buffer=t,f.onended=function(){this.finished=!0,f.finished&&n&&(n=!1,c=s=t.duration,l.dispatchEvent("finished"),r.removeEventListener("audioprocess",p),o=i.slice(0))},a=r.getAudio().Context.currentTime,f.start(0,s,e)}return this},this.stop=function(){return n=!1,f&&f.stop(),c=s=0,r.removeEventListener("audioprocess",p),o=i.slice(0),this},this.pause=function(){var t=n;return n=!1,f&&f.stop(),t&&(s+=r.getAudio().Context.currentTime-a),r.removeEventListener("audioprocess",p),this},this.seek=function(t){if(t<0)throw new TypeError("Offset parameter accepts non-negative numbers only.");return c+=t-this.getCurrentTime(),n?(n=!1,f&&f.stop(),s=t,this.play()):s=t,this},this.when=function(t,e){if(t<0)throw new TypeError("Marker parameter accepts non-negative numbers only.");var r={m:t,fn:e};return o.push(r),i.push(r),this},this.getCurrentTime=function(){return n?r.getAudio().Context.currentTime-a+s:s},this.getPlayedTime=function(){return u},this.getDuration=function(){return t.duration},this.isPlaying=function(){return n}};n.prototype=Object.create(e.prototype),n.prototype.constructor=n;var i=function(){e.call(this);var n=new r,i=this;this.getAudio=function(){return n},n.ScriptProcessor.onaudioprocess=function(){i.dispatchEvent("audioprocess")};var o=t.readStorage("eq"),s=t.readStorage("vol");o&&this.setEq(o),s&&this.setVolume(s)};i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.loadUrl=function(e){var r=this,i=t.getUrlPromise(e);return i||(i=e.reduce(function(e,n){return e.catch(function(){return t.getArrayBuffer(n).then(function(t){return r.getAudio().OfflineContext.decodeAudioData(t)})})},Promise.reject()).then(function(i){return t.removeUrlPromise(e),new n(i,r)}).catch(function(){throw new Error("No valid audio URLs provided.")}),t.setUrlPromise(e,i)),i},i.prototype.setVolume=function(e){return this.getAudio().Gain.gain.value=e,t.updateStorage("vol",e),this},i.prototype.getVolume=function(){return this.getAudio().Gain.gain.value},i.prototype.setEq=function(e){for(var r in e)e.hasOwnProperty(r)&&this.getAudio().filters[r]&&(this.getAudio().filters[r].gain.value=e[r]);return t.updateStorage("eq",this.getEq()),this},i.prototype.getEq=function(){var t=[];return this.getAudio().filters.forEach(function(e){t.push(e.gain.value)}),t},window.WebAudioPlayer=i}();